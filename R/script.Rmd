---
title: "Webscrap do tabnet da ANS"
output: html_notebook
---

```{r}
source("R/libraries.R")
```

# Ferramentas utilizadas

SelectorGadget: <https://rvest.tidyverse.org/articles/articles/selectorgadget.html>

SQLite Tools: <https://www.sqlite.org/download.html>

SQLite Browser: <https://sqlitebrowser.org/>

# Consulta teste

Consultas $\to$ Beneficiários $\to$ UF, Região Metropolitana e Capital

```{r}
tabnet_ans <- "http://www.ans.gov.br/anstabnet/cgi-bin/tabnet?dados/tabnet_br.def"
```

| Variável               | Opção                             |
|------------------------|-----------------------------------|
| Linha:                 | Faixa etária                      |
| Coluna:                | Sexo                              |
| Conteúdo:              | Assistência médica                |
| Sexo:                  | Masculino                         |
| Faixa etária:          | Até 1 ano, 1 a 4 anos, 5 a 9 anos |
| Faixa etária-Reajuste: | 00 a 18 anos                      |
| Tipo de contratação:   | Individual ou Familiar            |
| Período:               | Jun/2021                          |

: Beneficiários por UFs, Regiões Metropolitanas (RM) e Capitais Assistência Médica segundo Faixa etária

Fazendo a requisição:

```{r}
# mar-2000 - jun-2021
ano <- "tb_br_2106.dbf"

# Requisição encontrada por meio do console do navegador
data <- glue::glue("Linha=Faixa_et%E1ria&Coluna=--N%E3o-Ativa--&Incremento=Assist%EAncia_M%E9dica&Arquivos={ano}&SSexo=1&SFaixa_et%E1ria=1&SFaixa_et%E1ria=2&SFaixa_et%E1ria=3&SFaixa_et%E1ria-Reajuste=1&STipo_de_contrata%E7%E3o=1&S%C9poca_de_contrata%E7%E3o=TODAS_AS_CATEGORIAS__&SSegmenta%E7%E3o=TODAS_AS_CATEGORIAS__&SSegmenta%E7%E3o_grupo=TODAS_AS_CATEGORIAS__&SAbrg._Geogr%E1fica=TODAS_AS_CATEGORIAS__&SModalidade=TODAS_AS_CATEGORIAS__&SUF=TODAS_AS_CATEGORIAS__&SGrande_Regi%E3o=TODAS_AS_CATEGORIAS__&SCapital=TODAS_AS_CATEGORIAS__&SInterior=TODAS_AS_CATEGORIAS__&SReg._Metropolitana=TODAS_AS_CATEGORIAS__&formato=table&mostre=Mostra")

site <- httr::POST(url = tabnet_ans,
                   body = data, 
                   timeout(20))
```

Tratando os dados:

```{r}
dados <- httr::content(site, encoding = "Latin1", as = "parsed") |> # extrair os dados da rquisição
  rvest::html_element("table") |> # elemento desejado: dados retornados da requisição
  rvest::html_text2() |> # extração do texto da página gerada pela requisição
  tibble::as_tibble() 

dados |>
  tidyr::separate_rows(value, sep = "\n") |> 
  tidyr::separate(value, c("faixa_etaria", "assistencia_medica"), "\t") |> 
  dplyr::slice(-(1)) |> 
  dplyr::filter(faixa_etaria != "TOTAL")
```

# Criando base de tags

Conteúdo de campos:

```{r}
html <- rvest::read_html("http://www.ans.gov.br/anstabnet/cgi-bin/dh?dados/tabnet_br.def")

clear <- function(x){
  x |> 
    rvest::html_text() |>
    stringi::stri_trans_general(id = "Latin-ASCII") |> # Remover acentos na exportação
    tibble::as_tibble() |>
    tidyr::separate_rows(value, sep = "\n") |> 
    dplyr::rename(item = value) |> 
    dplyr::mutate(tag = "") |> 
    dplyr::slice(-n()) # Remover última linha por conta do último \n nas variáveis
}

#' Tags encontradas no site do tabnet da ANS:
#' <http://www.ans.gov.br/anstabnet/cgi-bin/dh?dados/tabnet_br.def>

linha <- html |> 
  rvest::html_element("#L") |>
  clear() |> 
  dplyr::mutate(tag = c("Compet%EAncia", "Sexo", "Faixa_et%E1ria", "Faixa_et%E1ria-Reajuste", "Tipo_de_contrata%E7%E3o", "%C9poca_de_contrata%E7%E3o", "Segmenta%E7%E3o", "Segmenta%E7%E3o_grupo", "Abrg._Geogr%E1fica", "Modalidade", "UF", "Grande_Regi%E3o%2FUF", "Grande_Regi%E3o", "Capital", "Interior", "Reg._Metropolitana")) |>
    readr::write_csv(glue::glue("base/linha.csv"))

coluna <- html |> 
  rvest::html_element("#C") |>
  clear() |> 
  dplyr::mutate(tag = c("--N%E3o-Ativa--", "Compet%EAncia", "Sexo", "Faixa_et%E1ria", "Faixa_et%E1ria-Reajuste", "Tipo_de_contrata%E7%E3o", "%C9poca_de_contrata%E7%E3o", "Segmenta%E7%E3o", "Segmenta%E7%E3o_grupo", "Abrg._Geogr%E1fica", "Modalidade", "UF", "Grande_Regi%E3o", "Capital", "Interior", "Reg._Metropolitana")) |>
  readr::write_csv(glue::glue("base/coluna.csv"))

conteudo <- html |> 
  rvest::html_element("#I") |>
  clear() |> 
  dplyr::mutate(tag = c("Assist%EAncia_M%E9dica", "Excl._Odontol%F3gico")) |>
  readr::write_csv(glue::glue("base/conteudo.csv"))

tipo_contratacao <- html |> 
  rvest::html_element("#S4") |>
  clear() |> 
  dplyr::mutate(tag = c("TODAS_AS_CATEGORIAS__", "1", "2", "3", "4", "5")) |>
  readr::write_csv(glue::glue("base/tipo_contratacao.csv"))  

uf <- html |> 
  rvest::html_element("#S10") |>
  clear() |>
  dplyr::mutate(tag = c("TODAS_AS_CATEGORIAS__", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "29", "28")) |>
  readr::write_csv(glue::glue("base/uf.csv")) 
```

Importação de bases no SQLite:

```
sqlite3

.cd "/webscrap-ans-tabnet/base"

.open ans-tags.db

.mode csv

.import coluna.csv coluna
```

Repetir para as demais bases.

# Conecção com base de dados

```{r}
database <- DBI::dbConnect(RSQLite::SQLite(), "base/ans-tags.db")

dbListTables(database)

database |> 
  dplyr::tbl("coluna") # seleciona a tabela
```

Criando busca:

```{r}
busca <- function(coluna, conteudo, linha, tipo_contratacao, uf){
  
  database <- DBI::dbConnect(RSQLite::SQLite(), "base/ans-tags.db")
  
  a <- database |> 
    dplyr::tbl("coluna") |>
    dplyr::filter(item == coluna) |> 
    dplyr::pull(tag)
  
  b <- database |> 
    dplyr::tbl("conteudo") |>
    dplyr::filter(item == conteudo) |> 
    dplyr::pull(tag)
  
  c <- database |> 
    dplyr::tbl("linha") |>
    dplyr::filter(item == linha) |> 
    dplyr::pull(tag)
  
  d <- database |> 
    dplyr::tbl("tipo_contratacao") |>
    dplyr::filter(item == tipo_contratacao) |> 
    dplyr::pull(tag)
  
  e <- database |> 
    dplyr::tbl("uf") |>
    dplyr::filter(item == uf) |> 
    dplyr::pull(tag)
  
  periodo <- "tb_br_2106.dbf"
  
  tabnet_ans <- "http://www.ans.gov.br/anstabnet/cgi-bin/tabnet?dados/tabnet_br.def"
  
  requisicao <- glue::glue("Linha={c}&Coluna={a}&Incremento={b}&Arquivos={periodo}&SSexo=TODAS_AS_CATEGORIAS__&SFaixa_et%E1ria=TODAS_AS_CATEGORIAS__&SFaixa_et%E1ria-Reajuste=TODAS_AS_CATEGORIAS__&STipo_de_contrata%E7%E3o={d}&S%C9poca_de_contrata%E7%E3o=TODAS_AS_CATEGORIAS__&SSegmenta%E7%E3o=TODAS_AS_CATEGORIAS__&SSegmenta%E7%E3o_grupo=TODAS_AS_CATEGORIAS__&SAbrg._Geogr%E1fica=TODAS_AS_CATEGORIAS__&SModalidade=TODAS_AS_CATEGORIAS__&SUF={e}&SGrande_Regi%E3o=TODAS_AS_CATEGORIAS__&SCapital=TODAS_AS_CATEGORIAS__&SInterior=TODAS_AS_CATEGORIAS__&SReg._Metropolitana=TODAS_AS_CATEGORIAS__&formato=table&mostre=Mostra")
  
  site <- httr::POST(url = tabnet_ans,
                   body = requisicao, 
                   timeout(20))
  
  dados <- httr::content(site, encoding = "Latin1", as = "parsed") |> # extrair os dados da requisição
    rvest::html_element("table") |> # elemento desejado: dados retornados da requisição
    rvest::html_text2() |> # extração do texto da página gerada pela requisição
    tibble::as_tibble() |>
    tidyr::separate_rows(value, sep = "\n")
  
  n <- 1 + dados |> 
    dplyr::slice(1) |> 
    dplyr::pull() |> 
    stringr::str_count(pattern = "\t")

  dados <- dados |>
    tidyr::separate(col = value, sep = "\t", into = paste0("x", 1:n)) |> 
    janitor::row_to_names(row_number = 1) |> 
    dplyr::slice(-1)
  
  return(dados)
}

dados <- busca(coluna = "Competencia",
               conteudo = "Assistencia Medica",
               linha = "Sexo",
               tipo_contratacao = "Individual ou Familiar", 
               uf = "Sao Paulo")

dados
```


